#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù¾Ø±ÙˆÚ˜Ù‡ ÙØ±Ø¯ÙˆØ³ÛŒ Ø­Ø³ÛŒÙ†ÛŒ
"""

import secrets
from datetime import datetime, timedelta
from flask import Blueprint, render_template, request, redirect, url_for, flash, session, current_app
from flask_login import login_user, logout_user, login_required, current_user
from flask_mail import Message
from werkzeug.security import generate_password_hash
from app import db, mail, limiter
from app.models import User
from app.forms import LoginForm, ChangePasswordForm, RegisterForm

auth_bp = Blueprint('auth', __name__)

@auth_bp.route('/login', methods=['GET', 'POST'])
@limiter.limit(lambda: current_app.config.get('RATELIMIT_LOGIN', "5 per minute"))  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ·
def login():
    """ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±"""
    
    if current_user.is_authenticated:
        return redirect(url_for('main.home'))
    
    form = LoginForm()
    if form.validate_on_submit():
        username = form.username.data.strip()
        password = form.password.data
        remember = form.remember_me.data
        
        # Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø§ÛŒÙ…ÛŒÙ„
        user = User.query.filter(
            (User.username == username) | (User.email == username)
        ).first()
        
        if user and user.check_password(password) and user.is_active:
            login_user(user, remember=remember)
            
            # Ù‡Ø¯Ø§ÛŒØª Ø¨Ù‡ ØµÙØ­Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± ÛŒØ§ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
            next_page = request.args.get('next')
            if next_page:
                return redirect(next_page)
            
            flash(f'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ØŒ {user.username}!', 'success')
            return redirect(url_for('main.home'))
        else:
            flash('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.', 'error')
    
    return render_template('auth/login.html', form=form)

@auth_bp.route('/register', methods=['GET', 'POST'])
def register():
    """Ø«Ø¨Øª Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯"""
    
    if current_user.is_authenticated:
        return redirect(url_for('main.home'))
    
    form = RegisterForm()
    if form.validate_on_submit():
        # Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø§ÛŒÙ…ÛŒÙ„
        if User.query.filter_by(username=form.username.data).first():
            flash('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø³Øª. âŒ', 'error')
            return render_template('auth/register.html', form=form)
        
        if User.query.filter_by(email=form.email.data).first():
            flash('Ø§ÛŒÙ…ÛŒÙ„ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª. âŒ', 'error')
            return render_template('auth/register.html', form=form)
        
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
        user = User(
            username=form.username.data,
            email=form.email.data.lower(),
            fullname=form.fullname.data,  # Ø§ÛŒÙ† Ø®Ø· Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
            role=form.role.data,
            is_active=False  # Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª
        )
        user.set_password(form.password.data)
        
        try:
            db.session.add(user)
            db.session.commit()
            flash('Ø«Ø¨Øª Ù†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯. Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ù¾Ø³ Ø§Ø² ØªØ§ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± ÙØ¹Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯. ğŸ‰', 'success')
            return redirect(url_for('auth.login'))
        
        except Exception as e:
            db.session.rollback()
            flash('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ø§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯. âŒ', 'error')
    
    return render_template('auth/register.html', form=form)

@auth_bp.route('/logout')
@login_required
def logout():
    """Ø®Ø±ÙˆØ¬ Ú©Ø§Ø±Ø¨Ø±"""
    logout_user()
    flash('Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯.', 'success')
    return redirect(url_for('main.home'))

@auth_bp.route('/profile')
@login_required
def profile():
    """Ù¾Ø±ÙˆÙØ§ÛŒÙ„ Ú©Ø§Ø±Ø¨Ø±"""
    return render_template('auth/profile.html')

@auth_bp.route('/change_password', methods=['GET', 'POST'])
@login_required
def change_password():
    """ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"""
    form = ChangePasswordForm()
    if form.validate_on_submit():
        if current_user.check_password(form.current_password.data):
            current_user.set_password(form.new_password.data)
            db.session.commit()
            flash('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.', 'success')
            return redirect(url_for('auth.profile'))
        else:
            flash('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± ÙØ¹Ù„ÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.', 'error')
    return render_template('auth/change_password.html', form=form)

@auth_bp.route('/forgot_password', methods=['GET', 'POST'])
def forgot_password():
    """ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"""
    
    if current_user.is_authenticated:
        return redirect(url_for('main.home'))
    
    if request.method == 'POST':
        email = request.form.get('email', '').strip().lower()
        
        if not email:
            flash('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error')
            return render_template('auth/forgot_password.html')
        
        user = User.query.filter_by(email=email).first()
        
        if user and user.is_active:
            # Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ
            reset_token = secrets.token_urlsafe(32)
            reset_expires = datetime.utcnow() + timedelta(hours=2)
            
            # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± session (Ø¯Ø± Ù…Ø­ÛŒØ· ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯)
            session[f'reset_token_{reset_token}'] = {
                'user_id': user.id,
                'expires': reset_expires.isoformat()
            }
            
            # Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
            try:
                send_reset_email(user, reset_token)
                flash('Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ù‡ Ø§ÛŒÙ…ÛŒÙ„ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.', 'success')
            except Exception as e:
                flash('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error')
        else:
            # Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØªØŒ Ù‡Ù…ÛŒØ´Ù‡ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…
            flash('Ø§Ú¯Ø± Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø¨Ø§Ø´Ø¯ØŒ Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.', 'info')
    
    return render_template('auth/forgot_password.html')

@auth_bp.route('/reset_password/<token>', methods=['GET', 'POST'])
def reset_password(token):
    """Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"""
    
    if current_user.is_authenticated:
        return redirect(url_for('main.home'))
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ØªÙˆÚ©Ù†
    reset_data = session.get(f'reset_token_{token}')
    if not reset_data:
        flash('Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.', 'error')
        return redirect(url_for('auth.forgot_password'))
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù†Ù‚Ø¶Ø§
    expires = datetime.fromisoformat(reset_data['expires'])
    if datetime.utcnow() > expires:
        session.pop(f'reset_token_{token}', None)
        flash('Ù„ÛŒÙ†Ú© Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª.', 'error')
        return redirect(url_for('auth.forgot_password'))
    
    user = User.query.get(reset_data['user_id'])
    if not user or not user.is_active:
        flash('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.', 'error')
        return redirect(url_for('auth.forgot_password'))
    
    if request.method == 'POST':
        password = request.form.get('password')
        password_confirm = request.form.get('password_confirm')
        
        if not password or len(password) < 6:
            flash('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û¶ Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯.', 'error')
        elif password != password_confirm:
            flash('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ùˆ ØªÚ©Ø±Ø§Ø± Ø¢Ù† Ø¨Ø§ÛŒØ¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯.', 'error')
        else:
            user.set_password(password)
            db.session.commit()
            session.pop(f'reset_token_{token}', None)
            flash('Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯. Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.', 'success')
            return redirect(url_for('auth.login'))
    
    return render_template('auth/reset_password.html')

@auth_bp.route('/users')
@login_required
def users_list():
    """Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù†"""
    
    if not current_user.is_admin():
        flash('Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.', 'error')
        return redirect(url_for('main.home'))
    
    users = User.query.order_by(User.created_at.desc()).all()
    return render_template('auth/users_list.html', users=users)

@auth_bp.route('/toggle_user_status/<int:user_id>')
@login_required
def toggle_user_status(user_id):
    """ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø± - ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù†"""
    
    if not current_user.is_admin():
        flash('Ø´Ù…Ø§ Ù…Ø¬ÙˆØ² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø¹Ù…Ù„ÛŒØ§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯.', 'error')
        return redirect(url_for('main.home'))
    
    user = User.query.get_or_404(user_id)
    
    if user.id == current_user.id:
        flash('Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙˆØ¶Ø¹ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.', 'error')
        return redirect(url_for('auth.users_list'))
    
    user.is_active = not user.is_active
    
    try:
        db.session.commit()
        status = 'ÙØ¹Ø§Ù„' if user.is_active else 'ØºÛŒØ±ÙØ¹Ø§Ù„'
        flash(f'ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø± {user.username} Ø¨Ù‡ {status} ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.', 'success')
    except Exception as e:
        db.session.rollback()
        flash('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ú©Ø§Ø±Ø¨Ø±.', 'error')
    
    return redirect(url_for('auth.users_list'))

def send_reset_email(user, token):
    """Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±"""
    reset_link = url_for('auth.reset_password', token=token, _external=True)
    
    msg = Message(
        'Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± - Ø³Ø§ÛŒØª ÙØ±Ø¯ÙˆØ³ÛŒ Ø­Ø³ÛŒÙ†ÛŒ',
        sender=('ÙØ±Ø¯ÙˆØ³ÛŒ Ø­Ø³ÛŒÙ†ÛŒ', 'noreply@ferdowsihosseini.ir'),
        recipients=[user.email]
    )
    
    msg.body = f'''Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ØŒ Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:

{reset_link}

Ø§Ú¯Ø± Ø´Ù…Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±ÛŒØ¯.

Ø¨Ø§ Ø§Ø­ØªØ±Ø§Ù…ØŒ
ØªÛŒÙ… ÙØ±Ø¯ÙˆØ³ÛŒ Ø­Ø³ÛŒÙ†ÛŒ
'''
    
    msg.html = f'''
<p>Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø®ÙˆØ¯ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯:</p>

<p><a href="{reset_link}" style="display: inline-block; padding: 10px 20px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 5px;">Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</a></p>

<p>ÛŒØ§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù„ÛŒÙ†Ú© Ø²ÛŒØ± Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø®ÙˆØ¯ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯:</p>
<p><small>{reset_link}</small></p>

<p>Ø§Ú¯Ø± Ø´Ù…Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ù†Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø§ÛŒÙ…ÛŒÙ„ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</p>

<p>Ø¨Ø§ Ø§Ø­ØªØ±Ø§Ù…ØŒ<br>
ØªÛŒÙ… ÙØ±Ø¯ÙˆØ³ÛŒ Ø­Ø³ÛŒÙ†ÛŒ</p>
'''
    
    mail.send(msg)